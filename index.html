<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jade Heaven: Ultimate Sovereign</title>
    <style>
        :root { --realm-color: #d4af37; --demonic-color: #8a0000; --glow: 0 0 10px #d4af37; --bg-overlay: rgba(0,0,0,0.85); }
        body { 
            background: linear-gradient(var(--bg-overlay), var(--bg-overlay)), url('https://r.jina.ai/i/9e0e3b91c89047978935c102a9b3699c') no-repeat center center fixed; 
            background-size: cover; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; justify-content: center; padding: 10px; margin: 0;
            overflow-x: hidden; font-size: 14px;
        }
        #game-box { 
            background: rgba(10, 15, 12, 0.95); backdrop-filter: blur(15px); 
            border: 2px solid var(--realm-color); padding: 15px; width: 100%; max-width: 1300px;
            border-radius: 10px; box-shadow: 0 0 50px #000; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        /* Layout Grid */
        .layout { display: grid; grid-template-columns: 280px 1fr 280px; gap: 15px; }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

        .panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        h3 { color: var(--realm-color); border-bottom: 1px solid var(--realm-color); margin-top: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Components */
        #avatar-frame { width: 100%; height: 200px; border: 2px solid var(--realm-color); border-radius: 8px; overflow: hidden; margin-bottom: 10px; background: #000; position: relative;}
        #avatar-img { width: 100%; height: 100%; object-fit: contain; }
        
        button { background: #1a261f; color: #ffd700; border: 1px solid #d4af37; padding: 6px 12px; cursor: pointer; font-weight: bold; transition: 0.2s; border-radius: 4px; }
        button:hover:not(:disabled) { background: var(--realm-color); color: #000; box-shadow: 0 0 10px var(--realm-color); }
        button:disabled { opacity: 0.4; cursor: not-allowed; border-color: #555; color: #aaa; }
        
        .stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; margin-bottom: 4px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stat-val { color: var(--realm-color); font-weight: bold; font-family: 'Courier New', monospace; }
        
        /* Bars */
        .bar-container { width: 100%; background: #222; height: 12px; border-radius: 6px; margin: 5px 0; position: relative; overflow: hidden; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-text { position: absolute; top:0; left:0; width:100%; text-align:center; font-size:0.65rem; line-height:12px; text-shadow:1px 1px 2px #000; }
        
        /* Tabs */
        .tab-container { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 8px; background: #111; border: 1px solid #444; color: #888; }
        .tab-btn.active { background: #2a2a2a; color: var(--realm-color); border-color: var(--realm-color); }

        /* Grids & Lists */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .log-box { height: 150px; overflow-y: auto; background: rgba(0,0,0,0.6); padding: 8px; font-size: 0.8rem; border-radius: 4px; font-family: monospace; border-left: 2px solid var(--realm-color); }
        
        /* Specific Styles */
        .npc-card { border: 1px solid #555; padding: 8px; margin-bottom: 5px; background: rgba(0,0,0,0.3); }
        .companion-card { border: 1px solid #ff69b4; padding: 10px; margin-bottom: 5px; background: rgba(50, 0, 20, 0.4); border-radius: 5px; }
        .meridian-node { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; background: #222; }
        .meridian-active { border-color: #0ff; background: #004444; box-shadow: 0 0 5px #0ff; }
        
        /* Animations */
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-3px, -2px); } 100% { transform: translate(1px, 1px); } }
        .battle-shake { animation: shake 0.4s infinite; }
        
        /* Golden Breakthrough Effect */
        @keyframes gold-burst {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); background-color: rgba(255, 215, 0, 0); }
            10% { box-shadow: 0 0 100px 50px rgba(255, 215, 0, 0.8); background-color: rgba(255, 215, 0, 0.2); }
            100% { box-shadow: 0 0 200px 100px rgba(255, 215, 0, 0); background-color: rgba(255, 215, 0, 0); }
        }
        .level-up-anim { animation: gold-burst 1.5s ease-out; }
    </style>
</head>
<body>

<audio id="bgm1" loop src="Celestial_Ascension_1.mp3"></audio>
<audio id="bgm2" loop src="Celestial_Ascension_2.mp3"></audio>

<div id="setup" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#050505; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <h1 style="color:#d4af37; font-size:3rem; text-shadow:0 0 20px #d4af37;">JADE HEAVEN</h1>
    <p style="color:#888;">Ultimate Sovereign Edition</p>
    <input type="text" id="player-name" placeholder="Daoist Name" style="margin:10px; padding:10px; width:200px; text-align:center; background:#111; color:#fff; border:1px solid #444;">
    <input type="text" id="sect-name" placeholder="Sect Name" style="margin:10px; padding:10px; width:200px; text-align:center; background:#111; color:#fff; border:1px solid #444;">
    <button onclick="startGame()" style="width:200px; padding:15px; font-size:1.1rem; margin-top:20px;">Begin Path</button>
</div>

<div id="game-box" style="display:none;">
    
    <div style="display:flex; justify-content: space-between; align-items: center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
        <div>
            <h2 style="color:var(--realm-color); margin:0; font-size:1.4rem;"><span id="disp-sect-name">Sect</span> Master <span id="disp-name">Name</span></h2>
            <span style="font-size:0.75rem; color:#888;">Reputation: <span id="rep-val">Neutral</span> | Alignment: <span id="align-val">0</span></span>
        </div>
        <div style="text-align:right;">
            <button onclick="toggleMusic()" id="music-btn" style="font-size:0.7rem;">♫ ON</button>
            <button onclick="saveGame()" style="font-size:0.7rem;">Save</button>
            <button onclick="wipeSave()" style="font-size:0.7rem; border-color:#f44; color:#f44;">Wipe</button>
        </div>
    </div>

    <div class="layout">
        
        <div class="column">
            <div class="panel">
                <div id="avatar-frame"><img id="avatar-img" src="image_ff7109.png"></div>
                
                <div class="bar-container">
                    <div id="hp-bar" class="bar-fill" style="width:100%; background:#d32f2f;"></div>
                    <div class="bar-text">HP: <span id="hp-val">100</span>/<span id="max-hp">100</span></div>
                </div>
                <div class="bar-container">
                    <div id="dao-bar" class="bar-fill" style="width:100%; background:#7b1fa2;"></div>
                    <div class="bar-text">Dao Heart: <span id="dao-val">100</span>%</div>
                </div>

                <div class="stat-row"><span>Realm</span> <span id="realm-val" class="stat-val">Mortal</span></div>
                <div class="stat-row"><span>Qi</span> <span class="stat-val"><span id="qi-val">0</span> / <span id="qi-max">100</span></span></div>
                <progress id="qi-progress" value="0" max="100" style="width:100%; height:5px;"></progress>
                
                <hr style="border-color:#333; margin:5px 0;">
                <div class="stat-row"><span>Spirit Stones</span> <span id="stone-val" style="color:#ffd700;">0</span></div>
                <div class="stat-row"><span>Combat Power</span> <span id="power-val" style="color:#ff5252;">0</span></div>
                <div class="stat-row"><span>Karma</span> <span id="karma-val">1.00</span>x</div>
                
                <div class="grid-2" style="margin-top:10px;">
                    <button onclick="meditate()">Meditate</button>
                    <button onclick="explore()">Explore</button>
                    <button id="breakthrough-btn" style="grid-column:span 2; background:#550000; display:none;" onclick="attemptBreakthrough()">BREAKTHROUGH</button>
                </div>
            </div>

            <div class="panel">
                <h3>Attributes</h3>
                <div class="stat-row"><span>Strength (STR)</span> <span id="str-val">1</span></div>
                <div class="stat-row"><span>Agility (AGI)</span> <span id="agi-val">1</span></div>
                <div class="stat-row"><span>Intelligence (INT)</span> <span id="int-val">1</span></div>
                <div class="stat-row"><span>Titles</span> <span id="title-val" style="font-size:0.7rem;">None</span></div>
            </div>
        </div>

        <div class="column">
            <div class="tab-container">
                <button class="tab-btn active" onclick="setTab('sect')">Sect</button>
                <button class="tab-btn" onclick="setTab('social')">Social</button>
                <button class="tab-btn" onclick="setTab('garden')">Garden</button>
                <button class="tab-btn" onclick="setTab('combat')">Combat</button>
                <button class="tab-btn" onclick="setTab('meridians')">Body</button>
                <button class="tab-btn" onclick="setTab('city')">City</button>
            </div>

            <div id="tab-sect" class="game-tab">
                <div class="panel">
                    <h3>Sect Management</h3>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button onclick="buyAmt=1; updateUI()">x1</button>
                        <button onclick="buyAmt=10; updateUI()">x10</button>
                        <button onclick="buyAmt=100; updateUI()">x100</button>
                        <button onclick="buyAmt='MAX'; updateUI()">MAX</button>
                    </div>
                    <div class="stat-row">
                        <span>Disciple [Owned: <span id="cnt-disciple" style="color:#fff">0</span>]</span>
                        <button onclick="recruit('disciple')">Hire (<span id="cost-disciple">50</span>s)</button>
                    </div>
                    <div class="stat-row">
                        <span>Elder [Owned: <span id="cnt-elder" style="color:#fff">0</span>]</span>
                        <button onclick="recruit('elder')">Hire (<span id="cost-elder">500</span>s)</button>
                    </div>
                    <div class="stat-row">
                        <span>Array Master [Owned: <span id="cnt-array" style="color:#fff">0</span>]</span>
                        <button onclick="recruit('array')">Hire (<span id="cost-array">2.5k</span>s)</button>
                    </div>
                    
                    <hr>
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">Sect Loyalty: <span id="loyalty-val">100</span>%</div>
                    <button onclick="assignMission()" style="width:100%">Assign Mission (Req: 10 Disciples)</button>
                    <div id="mission-status" style="font-size:0.8rem; margin-top:5px; color:#aaa;">No active missions.</div>
                </div>
                
                <div class="panel">
                    <h3>Facilities</h3>
                    <button onclick="upgradeFacility('library')" style="width:100%">Build Grand Library (10k s)</button>
                    <div id="library-status" style="display:none; font-size:0.8rem; margin-top:5px;">Library Active: +20% INT Gain</div>
                </div>
            </div>

            <div id="tab-social" class="game-tab" style="display:none;">
                <div class="panel">
                    <h3>Dao Companions</h3>
                    <button onclick="seekCompanion()" style="width:100%; margin-bottom:10px;">Seek Companion (Cost: 5000s)</button>
                    <div id="companion-list"></div>
                </div>
                <div class="panel">
                    <h3>Encounters</h3>
                    <button onclick="findNPC()" style="width:100%; margin-bottom:10px;">Search for People (Cost: 100s)</button>
                    <div id="npc-list"></div>
                </div>
            </div>

            <div id="tab-garden" class="game-tab" style="display:none;">
                <div class="panel">
                    <h3>Spirit Beast</h3>
                    <div id="beast-slot">No beast bonded.</div>
                    <button onclick="trainBeast()">Train Beast (-50 Qi)</button>
                </div>
                <div class="panel">
                    <h3>Alchemy Cauldron</h3>
                    <div class="grid-2">
                        <select id="herb-1" style="background:#222; color:#fff; border:1px solid #555;"></select>
                        <select id="herb-2" style="background:#222; color:#fff; border:1px solid #555;"></select>
                    </div>
                    <button onclick="brewPill()" style="width:100%; margin-top:5px;">Refine Pill</button>
                </div>
                <div class="panel">
                    <h3>Herb Garden</h3>
                    <div id="garden-grid" class="grid-2"></div>
                </div>
            </div>

            <div id="tab-combat" class="game-tab" style="display:none;">
                <div class="panel">
                    <h3>Battle Skills</h3>
                    <div class="grid-2" style="margin-bottom:10px;">
                        <button onclick="useSkill('strike')">Qi Strike (100 Qi)</button>
                        <button onclick="useSkill('shield')">Spirit Shield (200 Qi)</button>
                        <button onclick="useSkill('heal')">Breath Recovery (300 Qi)</button>
                        <button onclick="useSkill('burst')">Blood Burst (50% HP)</button>
                    </div>
                </div>
                <div class="panel">
                    <h3>World Boss</h3>
                    <div style="text-align:center; padding:10px; border:1px solid #555; background:rgba(0,0,0,0.5);">
                        <h4 id="boss-name" style="margin:0; color:#ff5252;">Iron-Tusk Boar</h4>
                        <p style="font-size:0.8rem; margin:5px;">Power: <span id="boss-power">500</span> | Element: <span id="boss-elem">Earth</span></p>
                        <button onclick="fightBoss()">Challenge</button>
                    </div>
                </div>
            </div>

            <div id="tab-meridians" class="game-tab" style="display:none;">
                <div class="panel" style="text-align:center;">
                    <h3>Meridian Network</h3>
                    <p style="font-size:0.8rem;">Spend Qi to open acupoints.</p>
                    <div id="meridian-map" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
                        </div>
                </div>
            </div>

            <div id="tab-city" class="game-tab" style="display:none;">
                <div class="panel">
                    <h3>Heavenly Marketplace</h3>
                    <div id="market-items" class="grid-2"></div>
                    <button onclick="refreshMarket()" style="width:100%; margin-top:10px;">Refresh Market (200s)</button>
                </div>
                <div class="panel">
                    <h3>Blacksmith</h3>
                    <button onclick="upgradeArtifact()">Refine Weapon (Cost scales)</button>
                </div>
            </div>
        </div>

        <div class="column">
            <div class="panel">
                <h3>Inventory</h3>
                <div id="inventory" style="font-size:0.8rem; min-height:50px;">Empty.</div>
            </div>
            <div class="panel">
                <h3>Achievement Hall</h3>
                <div id="achievements" style="font-size:0.8rem; color:#aaa;">None yet.</div>
            </div>
            <div class="log-box" id="game-log">
                <div>[System] Welcome to the path of immortality.</div>
            </div>
            <div class="panel" style="margin-top:10px;">
                <button onclick="reincarnate()" id="reincarnate-btn" disabled style="width:100%; background:#333;">Reincarnate</button>
                <div style="font-size:0.7rem; text-align:center; margin-top:5px;">Req: Core Formation</div>
            </div>
        </div>
    </div>
</div>

<script>
/* ================= GAME CONFIGURATION ================= */
const CONFIG = {
    realms: ["Qi Condensation", "Foundation", "Core Formation", "Nascent Soul", "Spirit Severing", "Void", "Mahayana", "Immortal Emperor", "God"],
    images: ["image_ff7109.png", "image_09532f.png", "image_0953a8.png", "image_09541f.png", "image_0956ee.png", "image_095746.png", "image_095789.png", "image_095801.png", "image_095aed.png"],
    bosses: [
        {name: "Iron-Tusk Boar", power: 500, elem: "Earth", drop: "Boar Tusk"},
        {name: "Spirit Wolf", power: 3000, elem: "Wind", drop: "Wolf Core"},
        {name: "Blood Bat", power: 15000, elem: "Blood", drop: "Bat Wing"},
        {name: "Abyssal Dragon", power: 100000, elem: "Void", drop: "Dragon Scale"},
        {name: "Heavenly Guardian", power: 1000000, elem: "Light", drop: "Divine Shard"}
    ],
    herbs: ["Spirit Grass", "Ginseng", "Fire Flower", "Ice Lotus"],
    npcs: ["Citizen", "Noble", "Merchant", "Alchemist", "Blacksmith", "Sect Disciple", "Rogue Cultivator", "Demonic Cultivator", "Supreme Elder"],
    companions: [
        { name: "Jade Fox Spirit", buff: "AGI +10", type: "agi", val: 10 },
        { name: "Phoenix Saintess", buff: "Qi Gain +20%", type: "qi", val: 0.2 },
        { name: "Sword Empress", buff: "STR +15", type: "str", val: 15 },
        { name: "Dragon Princess", buff: "HP +500", type: "hp", val: 500 }
    ]
};

/* ================= GAME STATE ================= */
let state = {
    player: { name: "Daoist", sect: "Jade Heaven" },
    resources: { qi: 0, stones: 50, hp: 100, maxHp: 100, daoHeart: 100 },
    stats: { str: 1, agi: 1, int: 1, karma: 1.0, reputation: 0 },
    progression: { realmIdx: 0, bossIdx: 0, artifactLv: 0 },
    army: { disciple: 0, elder: 0, array: 0, loyalty: 100 },
    inventory: {},
    garden: [],
    meridians: [false, false, false, false, false],
    companions: [],
    beast: null,
    library: false,
    achievements: [],
    missionEnd: 0
};

let buyAmt = 1;
let bgm = document.getElementById('bgm1');
let musicOn = false;

/* ================= CORE LOOP ================= */
function startGame() {
    let pName = document.getElementById('player-name').value;
    let sName = document.getElementById('sect-name').value;
    if(pName) state.player.name = pName;
    if(sName) state.player.sect = sName;
    
    document.getElementById('disp-name').innerText = state.player.name;
    document.getElementById('disp-sect-name').innerText = state.player.sect;
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game-box').style.display = 'block';
    
    log("You have established the " + state.player.sect + " sect.");
    renderMeridians();
    updateUI();
    
    // Start Audio
    bgm.volume = 0.2;
}

function updateGame() {
    // Passive Generation
    let stoneGain = (state.army.disciple * 2 * state.stats.karma);
    let qiGain = (state.army.elder * 5 * state.stats.karma);
    
    // Apply Companion Buffs (Qi)
    state.companions.forEach(c => {
        if(c.type === 'qi') qiGain *= (1 + c.val);
    });

    if(state.library) qiGain *= 1.2;
    
    state.resources.stones += stoneGain;
    state.resources.qi += qiGain;
    
    // Healing
    if(state.army.array > 0 && state.resources.hp < state.resources.maxHp) {
        state.resources.hp = Math.min(state.resources.maxHp, state.resources.hp + state.army.array);
    }

    // Garden Growth
    state.garden.forEach(slot => {
        if(slot.progress < 100) slot.progress += 5;
    });

    // Mission Check
    if(state.missionEnd > 0 && Date.now() > state.missionEnd) {
        completeMission();
    }

    updateUI();
}

setInterval(updateGame, 1000);

/* ================= UI UPDATER ================= */
function updateUI() {
    // Top Bar
    document.getElementById('rep-val').innerText = state.stats.reputation > 50 ? "Righteous" : state.stats.reputation < -50 ? "Demonic" : "Neutral";
    document.getElementById('align-val').innerText = state.stats.reputation;

    // Vitals
    document.getElementById('hp-val').innerText = Math.floor(state.resources.hp);
    document.getElementById('max-hp').innerText = state.resources.maxHp;
    document.getElementById('hp-bar').style.width = (state.resources.hp / state.resources.maxHp * 100) + "%";
    
    document.getElementById('dao-val').innerText = Math.floor(state.resources.daoHeart);
    document.getElementById('dao-bar').style.width = state.resources.daoHeart + "%";

    // Resources
    let qiReq = (state.progression.realmIdx + 1) * 300 * Math.pow(2, state.progression.realmIdx);
    document.getElementById('qi-val').innerText = Math.floor(state.resources.qi);
    document.getElementById('qi-max').innerText = qiReq;
    document.getElementById('qi-progress').value = (state.resources.qi / qiReq) * 100;
    document.getElementById('stone-val').innerText = Math.floor(state.resources.stones);
    document.getElementById('karma-val').innerText = state.stats.karma.toFixed(2);

    // Realm & Image
    document.getElementById('realm-val').innerText = CONFIG.realms[state.progression.realmIdx];
    let imgIdx = Math.min(state.progression.realmIdx, CONFIG.images.length - 1);
    document.getElementById('avatar-img').src = CONFIG.images[imgIdx];

    // Stats
    document.getElementById('str-val').innerText = state.stats.str;
    document.getElementById('agi-val').innerText = state.stats.agi;
    document.getElementById('int-val').innerText = state.stats.int;
    document.getElementById('power-val').innerText = calculatePower();

    // Army
    document.getElementById('cnt-disciple').innerText = state.army.disciple;
    document.getElementById('cnt-elder').innerText = state.army.elder;
    document.getElementById('cnt-array').innerText = state.army.array;
    document.getElementById('loyalty-val').innerText = state.army.loyalty;

    // Costs
    document.getElementById('cost-disciple').innerText = getCost(50, state.army.disciple);
    document.getElementById('cost-elder').innerText = getCost(500, state.army.elder);
    document.getElementById('cost-array').innerText = getCost(2500, state.army.array);

    // Boss
    if(state.progression.bossIdx < CONFIG.bosses.length) {
        let b = CONFIG.bosses[state.progression.bossIdx];
        document.getElementById('boss-name').innerText = b.name;
        document.getElementById('boss-power').innerText = b.power;
        document.getElementById('boss-elem').innerText = b.elem;
    } else {
        document.getElementById('boss-name').innerText = "None (Ascend)";
    }

    // Buttons
    document.getElementById('breakthrough-btn').style.display = state.resources.qi >= qiReq ? 'block' : 'none';
    document.getElementById('reborn-btn').disabled = state.progression.realmIdx < 2;

    renderInventory();
    renderGarden();
    renderCompanions();
}

function getCost(base, count) {
    return Math.floor(base * Math.pow(1.15, count));
}

function calculatePower() {
    let base = (state.stats.str * 10) + (state.stats.agi * 5) + (state.stats.int * 2);
    
    // Apply Companion Buffs (Stats)
    state.companions.forEach(c => {
        if(c.type === 'str') base += c.val;
        if(c.type === 'agi') base += c.val;
    });

    let cultivation = state.progression.realmIdx * 1000;
    let army = (state.army.disciple * 2) + (state.army.elder * 20) + (state.army.array * 100);
    let art = state.progression.artifactLv * 500;
    return Math.floor(base + cultivation + army + art);
}

/* ================= ACTIONS ================= */
function meditate() {
    let gain = (5 + state.stats.int + (state.army.elder * 2)) * state.stats.karma;
    state.resources.qi += gain;
    if(state.resources.daoHeart < 100) state.resources.daoHeart += 0.5;
    updateUI();
}

function explore() {
    let roll = Math.random();
    if(roll < 0.3) {
        let found = Math.floor(Math.random() * 50) + 10;
        state.resources.stones += found;
        log("Found " + found + " Spirit Stones.");
    } else if (roll < 0.45) {
        let herb = CONFIG.herbs[Math.floor(Math.random() * CONFIG.herbs.length)];
        if(state.garden.length < 4) {
            state.garden.push({name: herb, progress: 0});
            log("Found a " + herb + " seed! Planted in garden.");
        } else {
            log("Found seed, but garden is full.");
        }
    } else if (roll < 0.5) {
        state.resources.hp -= 10;
        log("Attacked by a wild beast! Took 10 dmg.", "red");
    } else {
        log("You found nothing interesting.");
    }
    updateUI();
}

function attemptBreakthrough() {
    if(state.resources.daoHeart < 50) {
        log("Dao Heart too unstable! Risk of death!", "red");
        if(Math.random() < 0.5) {
            state.resources.qi = 0;
            log("Qi Deviation! Cultivation lost.", "red");
            return;
        }
    }
    
    // VISUAL EFFECT RESTORED
    let box = document.getElementById('game-box');
    box.classList.add('level-up-anim');
    setTimeout(() => box.classList.remove('level-up-anim'), 1500);

    state.progression.realmIdx++;
    state.resources.qi = 0;
    state.resources.maxHp += 200;
    state.resources.hp = state.resources.maxHp;
    state.stats.str += 10; state.stats.agi += 10; state.stats.int += 10;
    
    log("BREAKTHROUGH SUCCESSFUL! Welcome to " + CONFIG.realms[state.progression.realmIdx], "gold");
    updateUI();
}

/* ================= COMPANIONS ================= */
function seekCompanion() {
    if(state.resources.stones < 5000) return log("Need 5000 stones.");
    state.resources.stones -= 5000;
    
    if(Math.random() > 0.5) {
        let possible = CONFIG.companions.filter(c => !state.companions.some(sc => sc.name === c.name));
        if(possible.length > 0) {
            let newComp = possible[Math.floor(Math.random() * possible.length)];
            state.companions.push(newComp);
            log("You met the " + newComp.name + "! They joined you.", "pink");
            
            // Apply immediate HP buff if applicable
            if(newComp.type === 'hp') state.resources.maxHp += newComp.val;
        } else {
            log("You didn't find anyone new.");
        }
    } else {
        log("You searched but found no one.");
    }
    updateUI();
}

function dualCultivate(idx) {
    // Basic dual cultivation logic
    state.resources.qi += 500;
    state.resources.daoHeart = Math.min(100, state.resources.daoHeart + 10);
    log("Dual Cultivated with " + state.companions[idx].name + ". Qi +500, Dao Heart +10.", "pink");
    updateUI();
}

function renderCompanions() {
    let div = document.getElementById('companion-list');
    div.innerHTML = "";
    state.companions.forEach((c, i) => {
        div.innerHTML += `<div class="companion-card">
            <strong>${c.name}</strong><br>
            <span style="font-size:0.75rem; color:#aaa;">Bonus: ${c.buff}</span><br>
            <button onclick="dualCultivate(${i})" style="margin-top:5px; font-size:0.7rem; background:#400; border-color:#f66;">Dual Cultivate</button>
        </div>`;
    });
    if(state.companions.length === 0) div.innerHTML = "<div style='font-size:0.8rem; color:#888;'>No companions yet.</div>";
}

/* ================= SECT MANAGEMENT ================= */
function recruit(type) {
    let base = (type==='disciple')?50 : (type==='elder')?500 : 2500;
    let loop = (buyAmt === 'MAX') ? 1000 : buyAmt;
    let bought = 0;

    for(let i=0; i<loop; i++) {
        let cost = getCost(base, state.army[type]);
        if(state.resources.stones >= cost) {
            state.resources.stones -= cost;
            state.army[type]++;
            bought++;
        } else break;
    }
    if(bought > 0) log("Recruited " + bought + " " + type + "(s).");
    updateUI();
}

function assignMission() {
    if(state.army.disciple < 10) return log("Not enough disciples.", "red");
    if(state.missionEnd > 0) return log("Mission already active.");
    
    state.missionEnd = Date.now() + 30000; // 30 seconds
    document.getElementById('mission-status').innerText = "Mission in progress (30s)...";
    log("Disciples sent on mission.");
}

function completeMission() {
    state.missionEnd = 0;
    document.getElementById('mission-status').innerText = "No active missions.";
    let reward = Math.floor(state.stats.int * 50);
    state.resources.stones += reward;
    log("Mission complete! Gained " + reward + " stones.", "gold");
    state.army.loyalty = Math.min(100, state.army.loyalty + 1);
}

function upgradeFacility(type) {
    if(type === 'library') {
        if(state.resources.stones >= 10000 && !state.library) {
            state.resources.stones -= 10000;
            state.library = true;
            document.getElementById('library-status').style.display = 'block';
            log("Grand Library Built!");
        } else log("Cannot build library.");
    }
}

/* ================= SOCIAL / NPC ================= */
function findNPC() {
    if(state.resources.stones < 100) return log("Need 100 stones to gather info.");
    state.resources.stones -= 100;
    
    let npcType = CONFIG.npcs[Math.floor(Math.random() * CONFIG.npcs.length)];
    let html = `<div class="npc-card ${npcType.includes('Demonic') ? 'npc-demonic' : ''}">
        <strong>${npcType}</strong><br>
        <button onclick="interactNPC('${npcType}')">Interact</button>
    </div>`;
    document.getElementById('npc-list').innerHTML = html + document.getElementById('npc-list').innerHTML;
}

function interactNPC(type) {
    if(type === "Demonic Cultivator") {
        if(confirm("Trade Dao Heart (Safety) for Power?")) {
            state.resources.daoHeart -= 10;
            state.stats.str += 5;
            state.stats.reputation -= 10;
            log("You dealt with a demon. Power +5, Dao Heart -10.", "red");
        }
    } else if (type === "Citizen") {
        state.stats.reputation += 1;
        log("You helped a citizen. Reputation +1.");
    } else if (type === "Alchemist") {
        state.inventory["Unknown Pill"] = (state.inventory["Unknown Pill"] || 0) + 1;
        log("Alchemist gave you a pill.");
    } else {
        log("They bowed and left.");
    }
    updateUI();
}

/* ================= GARDEN & ALCHEMY ================= */
function renderGarden() {
    let d = document.getElementById('garden-grid');
    d.innerHTML = "";
    state.garden.forEach((slot, i) => {
        d.innerHTML += `<div style="border:1px solid #444; padding:5px;">
            ${slot.name}<br>
            <progress value="${slot.progress}" max="100"></progress><br>
            ${slot.progress >= 100 ? `<button onclick="harvest(${i})">Harvest</button>` : 'Growing...'}
        </div>`;
    });
    
    // Update Alchemy Selects
    let opts = `<option value="">Select Herb</option>`;
    for(let k in state.inventory) {
        if(CONFIG.herbs.includes(k)) opts += `<option value="${k}">${k} (${state.inventory[k]})</option>`;
    }
    document.getElementById('herb-1').innerHTML = opts;
    document.getElementById('herb-2').innerHTML = opts;
}

function harvest(idx) {
    let name = state.garden[idx].name;
    state.garden.splice(idx, 1);
    state.inventory[name] = (state.inventory[name] || 0) + 1;
    log("Harvested " + name);
    updateUI();
}

function brewPill() {
    let h1 = document.getElementById('herb-1').value;
    let h2 = document.getElementById('herb-2').value;
    if(!h1 || !h2) return log("Select two herbs.");
    if(!state.inventory[h1] || !state.inventory[h2]) return;
    
    state.inventory[h1]--;
    state.inventory[h2]--;
    
    state.stats.int += 2;
    state.stats.reputation += 1; 
    log("Alchemy Success! Intelligence +2.", "gold");
    updateUI();
}

/* ================= COMBAT ================= */
function useSkill(type) {
    if(type === 'strike') {
        if(state.resources.qi >= 100) { state.resources.qi -= 100; state.tempDmg = 500; log("Qi charged weapon!"); }
    } else if (type === 'heal') {
        if(state.resources.qi >= 300) { state.resources.qi -= 300; state.resources.hp = state.resources.maxHp; log("Fully Healed!"); }
    }
    updateUI();
}

function fightBoss() {
    let boss = CONFIG.bosses[state.progression.bossIdx];
    if(!boss) return;
    
    let pwr = calculatePower() + (state.tempDmg || 0);
    state.tempDmg = 0; 
    
    document.getElementById('game-box').classList.add('battle-shake');
    setTimeout(() => {
        document.getElementById('game-box').classList.remove('battle-shake');
        if(pwr >= boss.power) {
            log("VICTORY! Defeated " + boss.name, "gold");
            state.inventory[boss.drop] = (state.inventory[boss.drop] || 0) + 1;
            state.progression.bossIdx++;
            state.resources.stones += 1000;
            state.stats.reputation += 10;
        } else {
            state.resources.hp = 1;
            state.resources.daoHeart -= 5;
            log("DEFEAT! Your Dao Heart wavers...", "red");
        }
        updateUI();
    }, 500);
}

/* ================= MERIDIANS ================= */
function renderMeridians() {
    let html = "";
    state.meridians.forEach((unlocked, i) => {
        html += `<div class="meridian-node ${unlocked ? 'meridian-active' : ''}" onclick="unlockMeridian(${i})">M${i+1}</div>`;
    });
    document.getElementById('meridian-map').innerHTML = html;
}

function unlockMeridian(idx) {
    if(state.meridians[idx]) return;
    if(idx > 0 && !state.meridians[idx-1]) return log("Must unlock previous meridian first.");
    
    let cost = (idx + 1) * 1000;
    if(state.resources.qi >= cost) {
        state.resources.qi -= cost;
        state.meridians[idx] = true;
        state.stats.str += 5;
        state.stats.agi += 5;
        log("Meridian Opened! Stats increased.", "cyan");
        renderMeridians();
        updateUI();
    } else {
        log("Need " + cost + " Qi.");
    }
}

/* ================= SYSTEM ================= */
function setTab(name) {
    let tabs = document.getElementsByClassName('game-tab');
    for(let t of tabs) t.style.display = 'none';
    document.getElementById('tab-' + name).style.display = 'block';
    
    let btns = document.getElementsByClassName('tab-btn');
    for(let b of btns) b.classList.remove('active');
    event.target.classList.add('active');
}

function log(msg, color="#fff") {
    let d = new Date();
    let time = d.getHours() + ":" + d.getMinutes();
    let el = document.getElementById('game-log');
    el.innerHTML = `<div><span style="color:#888">[${time}]</span> <span style="color:${color}">${msg}</span></div>` + el.innerHTML;
}

function renderInventory() {
    let h = "";
    for(let k in state.inventory) {
        if(state.inventory[k] > 0) h += `<div style="display:inline-block; background:#333; padding:2px 5px; margin:2px; font-size:0.7rem;">${k} x${state.inventory[k]}</div>`;
    }
    document.getElementById('inventory').innerHTML = h || "Empty";
}

function toggleMusic() {
    musicOn = !musicOn;
    let btn = document.getElementById('music-btn');
    if(musicOn) { bgm.play().catch(e=>console.log(e)); btn.innerText = "♫ ON"; btn.style.color = "#0f0"; }
    else { bgm.pause(); btn.innerText = "♫ OFF"; btn.style.color = "#fff"; }
}

function saveGame() {
    localStorage.setItem('jadeUltimateSave', JSON.stringify(state));
    log("Game Saved.");
}

function wipeSave() {
    if(confirm("Delete all progress?")) {
        localStorage.removeItem('jadeUltimateSave');
        location.reload();
    }
}

function reincarnate() {
    if(confirm("Reincarnate? You keep Artifacts & Achievements but reset Realm.")) {
        state.stats.karma += (state.progression.realmIdx * 0.5);
        state.progression.realmIdx = 0;
        state.resources.qi = 0;
        state.resources.stones = 100;
        state.army = { disciple:0, elder:0, array:0, loyalty:100 };
        log("Reincarnation successful! Karma increased.");
        updateUI();
    }
}

// Init
const saved = localStorage.getItem('jadeUltimateSave');
if(saved) {
    state = JSON.parse(saved);
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game-box').style.display = 'block';
    document.getElementById('disp-name').innerText = state.player.name;
    document.getElementById('disp-sect-name').innerText = state.player.sect;
    renderMeridians();
    updateUI();
}

</script>
</body>
</html>
